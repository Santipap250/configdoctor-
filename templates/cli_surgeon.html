<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>The CLI Surgeon ‚Äî ConfigDoctor</title>

  <!-- Minimal, self-contained dark UI styles (‡∏õ‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö site CSS ‡∏Ç‡∏≠‡∏á‡∏ï‡∏∏‡πâ‡∏¢) -->
  <style>
    :root{
      --bg:#0b0c0d; --card:#0f1113; --muted:#9aa0a6;
      --accent:#2dd4bf; --danger:#ff6b6b; --warn:#ffb86b; --info:#60a5fa;
      --glass: rgba(255,255,255,0.03);
      --radius:12px; font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    html,body{height:100%; margin:0; background: linear-gradient(180deg,#070708 0%, #0b0c0d 100%); color:#e6eef3;}
    .wrap{max-width:1100px; margin:28px auto; padding:20px; border-radius:16px; background: linear-gradient(180deg, rgba(255,255,255,0.01), transparent); box-shadow: 0 6px 30px rgba(0,0,0,0.6);}
    header{display:flex; gap:16px; align-items:center; margin-bottom:16px;}
    .brand{display:flex; align-items:center; gap:12px;}
    .logo{width:52px; height:52px; border-radius:10px; background:linear-gradient(135deg,var(--accent),#7dd3fc); display:flex; align-items:center; justify-content:center; font-weight:700; color:#04111a;}
    h1{font-size:20px; margin:0;}
    p.lead{margin:0; color:var(--muted); font-size:13px;}

    .grid{display:grid; grid-template-columns: 1fr 420px; gap:18px; margin-top:18px;}
    .panel{background:var(--card); padding:14px; border-radius:var(--radius); box-shadow: inset 0 1px 0 rgba(255,255,255,0.02);}
    .dropzone{min-height:220px; border:1px dashed rgba(255,255,255,0.04); padding:10px; border-radius:10px; display:flex; flex-direction:column;}
    textarea#dump{resize:vertical; width:100%; min-height:160px; background:transparent; border:0; color:inherit; outline:none; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace; font-size:13px;}
    .tools{display:flex; gap:8px; margin-top:10px; flex-wrap:wrap;}
    button.btn{background:var(--glass); border:1px solid rgba(255,255,255,0.03); color:var(--accent); padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:600;}
    button.ghost{background:transparent; color:var(--muted); border:1px solid rgba(255,255,255,0.02);}
    .btn.danger{color:var(--danger); border-color: rgba(255,107,107,0.12);}
    .small{padding:6px 10px; font-size:13px;}
    .result{padding:12px; border-radius:10px; background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent); font-family: ui-monospace, monospace; font-size:13px; white-space:pre-wrap; color:#dbeafe;}
    .summary{display:flex; gap:12px; align-items:center; flex-wrap:wrap;}
    .badge{padding:6px 8px; border-radius:999px; font-weight:700; font-size:12px; color:#04111a;}
    .badge.good{background:#86efac;}
    .badge.info{background:var(--info); color:white;}
    .badge.warn{background:var(--warn); color:#04111a;}
    .badge.danger{background:var(--danger); color:white;}
    .rules{margin-top:8px; display:flex; flex-direction:column; gap:8px;}
    .rule{padding:10px; border-radius:8px; background: linear-gradient(90deg, rgba(255,255,255,0.01), transparent); display:flex; gap:10px; align-items:flex-start;}
    .rule .left{width:8px; border-radius:6px; margin-top:4px;}
    .rule .body{flex:1;}
    .rule h4{margin:0; font-size:14px;}
    .rule p{margin:4px 0 0 0; color:var(--muted); font-size:13px;}
    .cmds{margin-top:10px; display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
    .cli-box{background:#061018; border-radius:10px; padding:12px; border:1px solid rgba(255,255,255,0.02); font-family: ui-monospace, monospace;}
    .cli-line{display:flex; gap:8px; align-items:center; justify-content:space-between;}
    .copy{background:linear-gradient(90deg,#1f2937,#111827); padding:6px 8px; border-radius:8px; color:var(--muted); border:1px solid rgba(255,255,255,0.02); cursor:pointer; font-size:13px;}
    .muted{color:var(--muted); font-size:13px;}
    .footer{margin-top:16px; color:var(--muted); font-size:13px; display:flex; justify-content:space-between; gap:12px; align-items:center;}
    @media (max-width:980px){
      .grid{grid-template-columns:1fr; }
      .panel{padding:12px;}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">CS</div>
        <div>
          <h1>ü©∫ The CLI Surgeon</h1>
          <p class="lead">‡∏ß‡∏≤‡∏á <code>diff all</code> ‡∏´‡∏£‡∏∑‡∏≠ <code>dump</code> ‡∏à‡∏≤‡∏Å Betaflight ‚Üí ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏´‡∏≤ config ‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á CLI ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</p>
        </div>
      </div>
      <div style="margin-left:auto; text-align:right;">
        <div class="muted">ConfigDoctor ¬∑ Diagnostic Tool</div>
        <div class="muted" style="margin-top:6px;">‡∏°‡∏µ‡πÇ‡∏´‡∏°‡∏î offline ‡∏´‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á</div>
      </div>
    </header>

    <div class="grid">
      <!-- Left: input + controls -->
      <section class="panel">
        <div style="display:flex; gap:12px; align-items:center; justify-content:space-between;">
          <div class="summary">
            <div class="badge info">ANALYZE</div>
            <div class="muted">Paste / Drop / Upload your CLI dump</div>
          </div>
          <div>
            <button class="btn small" id="sampleBtn">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</button>
            <button class="btn small ghost" id="clearBtn">‡∏•‡πâ‡∏≤‡∏á</button>
          </div>
        </div>

        <div class="dropzone" id="dropzone" style="margin-top:12px;">
          <textarea id="dump" placeholder="‡∏ß‡∏≤‡∏á diff all / dump ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏≤‡∏ß‡∏≤‡∏á..." aria-label="CLI dump"></textarea>
          <div class="tools">
            <button class="btn" id="analyzeBtn">üîé Analyze</button>
            <button class="btn ghost small" id="analyzeLocalBtn">üñ•Ô∏è Analyze (local fallback)</button>
            <label class="btn ghost small" style="display:inline-flex; align-items:center; gap:8px; cursor:pointer;">
              üìÅ Upload
              <input type="file" id="fileInput" accept=".txt,.log" style="display:none;">
            </label>
            <button class="btn small" id="downloadBtn">‚¨áÔ∏è Download report</button>
          </div>
          <div style="margin-top:8px; color:var(--muted); font-size:13px;">
            ‡πÄ‡∏Ñ‡∏•‡πá‡∏î‡∏•‡∏±‡∏ö: ‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å Betaflight CLI (diff all) ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏ü‡∏•‡πå dump ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
          </div>
        </div>

        <div style="margin-top:12px; display:flex; gap:8px; align-items:center;">
          <div class="muted">Server:</div>
          <div id="serverStatus" class="badge" style="background:rgba(255,255,255,0.03); color:var(--muted); font-weight:600; padding:6px 8px; border-radius:8px;">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...</div>
        </div>
      </section>

      <!-- Right: results -->
      <aside class="panel">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <div>
            <div class="muted">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</div>
            <div id="summaryText" style="font-weight:700; margin-top:6px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</div>
          </div>
          <div style="text-align:right;">
            <div id="severitySummary" style="display:flex; gap:6px; align-items:center;">
              <div class="badge good" id="okBadge" style="display:none;">OK</div>
              <div class="badge warn" id="warnBadge" style="display:none;">WARN</div>
              <div class="badge danger" id="critBadge" style="display:none;">CRIT</div>
            </div>
          </div>
        </div>

        <div id="rulesArea" class="rules" style="margin-top:12px;">
          <!-- rules injected here -->
        </div>

        <div style="margin-top:12px;">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <div class="muted">‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á CLI ‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</div>
            <div>
              <button class="copy" id="copyAllBtn">Copy all</button>
            </div>
          </div>

          <div class="cli-box" id="cliBox" style="margin-top:8px; min-height:80px;">
            <div id="cliLines" style="display:flex; flex-direction:column; gap:6px;">
              <div class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ ‚Äî ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡πà‡∏≠‡∏ô</div>
            </div>
          </div>
        </div>

        <div style="margin-top:12px;">
          <div class="muted">‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ (raw)</div>
          <pre id="rawParams" class="result" style="height:120px; overflow:auto; margin-top:8px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</pre>
        </div>

        <div class="footer">
          <div>‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô: 1.0 ¬∑ The CLI Surgeon</div>
          <div class="muted">‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡πÄ‡∏û‡∏¥‡πà‡∏° ‡∏ö‡∏≠‡∏Å‡∏ú‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢</div>
        </div>
      </aside>
    </div>
  </div>

<script>
/*
  client-side logic:
  - fetch server /analyze_cli if available
  - fallback to local basic analyzer if server not reachable
  - pretty render rules, severity badges, CLI suggestions
  - drag & drop / file upload support, copy/download
*/

const serverStatusEl = document.getElementById('serverStatus');
const dumpEl = document.getElementById('dump');
const analyzeBtn = document.getElementById('analyzeBtn');
const analyzeLocalBtn = document.getElementById('analyzeLocalBtn');
const rulesArea = document.getElementById('rulesArea');
const cliLines = document.getElementById('cliLines');
const rawParams = document.getElementById('rawParams');
const summaryText = document.getElementById('summaryText');
const copyAllBtn = document.getElementById('copyAllBtn');
const downloadBtn = document.getElementById('downloadBtn');
const sampleBtn = document.getElementById('sampleBtn');
const fileInput = document.getElementById('fileInput');
const clearBtn = document.getElementById('clearBtn');

let lastResult = null;

// Check server availability
async function checkServer(){
  try{
    const r = await fetch('/analyze_cli', {method:'OPTIONS'});
    if (r.ok || r.status===200 || r.status===204){
      serverStatusEl.textContent = 'Online';
      serverStatusEl.style.background = 'var(--accent)';
      serverStatusEl.style.color = '#04111a';
      return true;
    }
    // some servers may not support OPTIONS ‚Äî try a lightweight POST
    serverStatusEl.textContent = 'Online';
    serverStatusEl.style.background = 'var(--accent)';
    serverStatusEl.style.color = '#04111a';
    return true;
  }catch(e){
    serverStatusEl.textContent = 'Offline (local fallback)';
    serverStatusEl.style.background = 'transparent';
    serverStatusEl.style.color = 'var(--muted)';
    return false;
  }
}
checkServer();

// basic local analyzer (JS) ‚Äî conservative checks, similar to server rules
function parseDumpToParams(text){
  const params = {};
  const lines = text.split(/\r?\n/);
  for (let raw of lines){
    let l = raw.trim();
    if (!l) continue;
    // match "set name = value" or "name = value"
    const m = l.match(/^(?:set\s+)?([a-z0-9_\-]+)\s*=\s*(.+)$/i);
    if (m){
      const key = m[1].toLowerCase();
      let val = m[2].replace(/\s+#.*$/,'').trim();
      params[key]=val;
      continue;
    }
    // some CLI outputs are "pid_p = 50" etc captured above
  }
  return params;
}

function localAnalyze(params){
  const rules = [];
  // min_throttle / mincommand
  const minKeys = ['min_throttle','mincommand','min_throttle_percent'];
  for (let k of minKeys){
    if (params[k]){
      const v = parseFloat(params[k]);
      if (!isNaN(v)){
        if (v < 1000){
          rules.push({id:'min_throttle_low', level:'warning', msg:`min_throttle ‡∏ï‡πà‡∏≥ (${v}) ‚Äî ‡∏≠‡∏≤‡∏à‡πÄ‡∏Å‡∏¥‡∏î motor stutter/idle`, suggestion:'‡∏•‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏° min_throttle ‡πÄ‡∏õ‡πá‡∏ô 1000-1020 ‡πÅ‡∏•‡∏∞‡∏ó‡∏î‡∏™‡∏≠‡∏ö hover'});
        } else if (v > 1100){
          rules.push({id:'min_throttle_high', level:'info', msg:`min_throttle ‡∏™‡∏π‡∏á (${v})`, suggestion:'‡∏ñ‡πâ‡∏≤ throttle deadband ‡∏´‡∏£‡∏∑‡∏≠ response ‡πÅ‡∏¢‡πà‡πÉ‡∏´‡πâ‡∏•‡∏î‡∏Ñ‡πà‡∏≤‡∏•‡∏á'});
        }
      }
    }
  }

  // failsafe detection
  const lowerKeys = Object.keys(params).join(' ');
  if (!/failsafe|failsafe_delay|failsafe_off/i.test(lowerKeys)){
    rules.push({id:'no_failsafe', level:'warning', msg:'‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ failsafe', suggestion:'‡∏ï‡∏±‡πâ‡∏á failsafe action (land/drop) ‡πÅ‡∏•‡∏∞ delay ‡∏ï‡∏≤‡∏°‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠'});
  }

  // looptime
  if (params['looptime']){
    const lt = parseInt(params['looptime']);
    if (!isNaN(lt)){
      if (lt < 1000) rules.push({id:'looptime_low', level:'warning', msg:`looptime ‡∏ï‡πà‡∏≥ (${lt} ¬µs)`, suggestion:'‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö ESC/CPU compatibility'});
      if (lt > 4000) rules.push({id:'looptime_high', level:'warning', msg:`looptime ‡∏™‡∏π‡∏á (${lt} ¬µs)`, suggestion:'‡∏•‡∏î looptime ‡πÄ‡∏û‡∏∑‡πà‡∏≠ latency ‡∏ï‡πà‡∏≥‡∏•‡∏á ‡∏ñ‡πâ‡∏≤‡∏Æ‡∏≤‡∏£‡πå‡∏î‡πÅ‡∏ß‡∏£‡πå‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö'});
    }
  }

  // PID extremes (check some common keys)
  ['p_roll','p_pitch','p_yaw','pid_p'].forEach(k=>{
    if (params[k]){
      const v = parseFloat(params[k]);
      if (!isNaN(v) && v > 80){
        rules.push({id:'pid_high_'+k, level:'critical', msg:`${k} ‡∏™‡∏π‡∏á‡∏°‡∏≤‡∏Å (${v})`, suggestion:'‡∏•‡∏î P ‡∏•‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ñ‡πà‡∏≤‡∏ñ‡∏π‡∏Å import ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'});
      }
    }
  });

  return rules;
}

function suggestCliFixes(rules, params){
  const fixes = [];
  for (let r of rules){
    if (r.id==='min_throttle_low'){
      fixes.push('set min_throttle = 1000');
    }
    if (r.id.startsWith('pid_high_')){
      // try reduce by 20%
      const key = r.id.replace('pid_high_','');
      const cur = parseFloat(params[key]||params['p_'+key]||0) || NaN;
      if (!isNaN(cur) && cur>0){
        const newv = Math.round(cur * 0.8 * 1000)/1000;
        fixes.push(`set ${key} = ${newv}`);
      }
    }
    if (r.id==='no_failsafe'){
      fixes.push('# Review failsafe settings (example):');
      fixes.push('set failsafe_delay = 10');
      fixes.push('set failsafe_off_delay = 60');
      fixes.push('set failsafe_throttle = 1000');
    }
  }
  // always add save
  if (fixes.length) fixes.push('save');
  return fixes;
}

// render helpers
function renderRules(rules){
  rulesArea.innerHTML = '';
  if (!rules.length){
    const el = document.createElement('div');
    el.className='muted';
    el.textContent = '‚úÖ ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÉ‡∏´‡∏ç‡πà‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô';
    rulesArea.appendChild(el);
    return;
  }
  rules.forEach(r=>{
    const wrapper = document.createElement('div');
    wrapper.className='rule';
    const left = document.createElement('div');
    left.className='left';
    left.style.background = (r.level==='critical'?'var(--danger)':(r.level==='warning'?'var(--warn)':'var(--info)'));
    const body = document.createElement('div');
    body.className='body';
    const h = document.createElement('h4');
    h.textContent = `[${r.level.toUpperCase()}] ${r.msg}`;
    const p = document.createElement('p');
    p.textContent = r.suggestion;
    body.appendChild(h); body.appendChild(p);
    wrapper.appendChild(left); wrapper.appendChild(body);
    rulesArea.appendChild(wrapper);
  });
}

// render cli suggestions
function renderCli(fixes){
  cliLines.innerHTML = '';
  if (!fixes || fixes.length===0){
    cliLines.innerHTML = '<div class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</div>';
    return;
  }
  fixes.forEach((c, idx)=>{
    const row = document.createElement('div');
    row.className='cli-line';
    const left = document.createElement('div');
    left.style.flex='1';
    left.textContent = c;
    const copyBtn = document.createElement('button');
    copyBtn.className='copy';
    copyBtn.textContent = 'Copy';
    copyBtn.onclick = ()=>{ navigator.clipboard.writeText(c); copyBtn.textContent='Copied'; setTimeout(()=>copyBtn.textContent='Copy',1200); };
    row.appendChild(left);
    row.appendChild(copyBtn);
    cliLines.appendChild(row);
  });
}

// fill raw params
function renderRawParams(params){
  const pretty = JSON.stringify(params, null, 2);
  rawParams.textContent = pretty || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ';
}

// main analyze flow: try server, fallback to local
async function analyzeFlow(useLocal=false){
  const txt = dumpEl.value.trim();
  if (!txt){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ß‡∏≤‡∏á diff all / dump ‡∏Å‡πà‡∏≠‡∏ô'); return; }
  summaryText.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå...';
  rulesArea.innerHTML = '';
  cliLines.innerHTML = '<div class="muted">‡∏£‡∏≠‡∏ú‡∏•...</div>';
  rawParams.textContent = '‡∏≠‡πà‡∏≤‡∏ô‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå...';

  // try server if not forcing local
  if (!useLocal){
    try{
      const res = await fetch('/analyze_cli', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({dump: txt})
      });
      if (res.ok){
        const j = await res.json();
        applyResult(j);
        return;
      } else {
        // fallthrough to local
        console.warn('server analyze failed, status', res.status);
      }
    }catch(e){
      console.warn('server analyze error', e);
    }
  }

  // local fallback
  const params = parseDumpToParams(txt);
  const rules = localAnalyze(params);
  const fixes = suggestCliFixes(rules, params);
  const out = {summary:`‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ: ${Object.keys(params).length}`, rules, fix_commands: fixes, params};
  applyResult(out);
}

function applyResult(j){
  lastResult = j;
  // summary
  summaryText.textContent = j.summary || '‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏•‡πâ‡∏ß';
  // rules normalization (server may return different keys)
  let rules = j.rules || j.rules || [];
  // accept if server returns objects with msg & suggestion
  if (rules && rules.length && typeof rules[0] === 'string'){
    rules = rules.map((s,i)=>({id:'r'+i, level:'info', msg:s, suggestion:''}));
  }
  renderRules(rules);
  // cli fixes
  const fixes = j.fix_commands || j.fix_commands || j.fix_commands || j.fixCommands || j.fix_commands || [];
  renderCli(fixes);
  // raw params
  renderRawParams(j.params || {});
  updateSeverityBadge(rules);
}

function updateSeverityBadge(rules){
  const ok = document.getElementById('okBadge');
  const warn = document.getElementById('warnBadge');
  const crit = document.getElementById('critBadge');
  ok.style.display='none'; warn.style.display='none'; crit.style.display='none';
  if (!rules || rules.length===0){ ok.style.display='inline-block'; return; }
  const lv = rules.map(r=>r.level);
  if (lv.includes('critical') || lv.includes('danger')) crit.style.display='inline-block';
  if (lv.includes('warning')) warn.style.display='inline-block';
  if (!lv.includes('warning') && !lv.includes('critical') && lv.includes('info')) ok.style.display='inline-block';
}

// events
analyzeBtn.onclick = ()=>{ analyzeFlow(false); };
analyzeLocalBtn.onclick = ()=>{ analyzeFlow(true); };
copyAllBtn.onclick = ()=>{
  if (!lastResult || !lastResult.fix_commands || lastResult.fix_commands.length===0){ alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å'); return;}
  const txt = lastResult.fix_commands.join('\n');
  navigator.clipboard.writeText(txt).then(()=>{ copyAllBtn.textContent='Copied'; setTimeout(()=>copyAllBtn.textContent='Copy all',1200); });
};
downloadBtn.onclick = ()=>{
  if (!lastResult){ alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô'); return; }
  const blob = new Blob([JSON.stringify(lastResult, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'cli_surgeon_report.json';
  a.click(); URL.revokeObjectURL(url);
};
sampleBtn.onclick = ()=>{
  const sample = `# sample diff all
set min_throttle = 980
set looptime = 500
set p_roll = 95
# end`;
  dumpEl.value = sample;
};
fileInput.onchange = (ev)=>{
  const f = ev.target.files[0];
  if (!f) return;
  const reader = new FileReader();
  reader.onload = ()=>{ dumpEl.value = reader.result; };
  reader.readAsText(f);
};
clearBtn.onclick = ()=>{ dumpEl.value=''; rulesArea.innerHTML=''; cliLines.innerHTML='<div class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</div>'; rawParams.textContent='‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'; summaryText.textContent='‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå'; lastResult=null; };

// drag & drop
const dz = document.getElementById('dropzone');
dz.addEventListener('dragover', e=>{ e.preventDefault(); dz.style.borderColor='rgba(255,255,255,0.06)'; });
dz.addEventListener('dragleave', e=>{ dz.style.borderColor='rgba(255,255,255,0.04)'; });
dz.addEventListener('drop', e=>{
  e.preventDefault(); dz.style.borderColor='rgba(255,255,255,0.04)';
  const f = e.dataTransfer.files && e.dataTransfer.files[0];
  if (f){
    const r = new FileReader();
    r.onload = ()=> dumpEl.value = r.result;
    r.readAsText(f);
  } else {
    // maybe text dropped
    const txt = e.dataTransfer.getData('text');
    if (txt) dumpEl.value = txt;
  }
});

// initial server check and set placeholder if needed
(async ()=>{ const ok = await checkServer(); if (!ok) serverStatusEl.textContent='Offline (local fallback)'; })();

</script>
</body>
</html>