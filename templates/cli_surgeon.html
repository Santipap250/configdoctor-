<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>The CLI Surgeon ‚Äî ConfigDoctor</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body class="cs-body">

  <main class="cs-wrap">
    <header class="cs-header">
      <div class="cs-brand">
        <div class="cs-logo">CS</div>
        <div class="cs-title-block">
          <h1 class="cs-title">ü©∫ The CLI Surgeon</h1>
          <p class="cs-lead">‡∏ß‡∏≤‡∏á <code>diff all</code> ‡∏´‡∏£‡∏∑‡∏≠ <code>dump</code> ‡∏à‡∏≤‡∏Å Betaflight ‚Üí ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏´‡∏≤ config ‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á CLI ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</p>
        </div>
      </div>

      <div class="cs-meta">
        <div class="cs-sub muted">ConfigDoctor ¬∑ Diagnostic Tool</div>
        <div class="cs-sub muted">‡∏°‡∏µ‡πÇ‡∏´‡∏°‡∏î offline ‡∏´‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á</div>
      </div>
    </header>

    <section class="cs-grid">
      <!-- Left column: input -->
      <section class="cs-panel cs-input-panel">
        <div class="cs-panel-top">
          <div class="cs-summary">
            <span class="cs-badge cs-badge-info">ANALYZE</span>
            <span class="muted">Paste / Drop / Upload your CLI dump</span>
          </div>

          <div class="cs-panel-actions">
            <button id="sampleBtn" class="cs-btn cs-btn-primary cs-btn-sm">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</button>
            <button id="clearBtn" class="cs-btn cs-btn-ghost cs-btn-sm">‡∏•‡πâ‡∏≤‡∏á</button>
          </div>
        </div>

        <div id="dropzone" class="cs-dropzone" aria-label="CLI dump dropzone">
          <textarea id="dump" class="cs-textarea" placeholder="‡∏ß‡∏≤‡∏á diff all / dump ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."></textarea>

          <div class="cs-tools">
            <button id="analyzeBtn" class="cs-btn cs-btn-primary">üîé Analyze</button>
            <button id="analyzeLocalBtn" class="cs-btn cs-btn-ghost">üñ•Ô∏è Analyze (local)</button>

            <label class="cs-upload cs-btn cs-btn-ghost">
              üìÅ Upload
              <input id="fileInput" type="file" accept=".txt,.log" class="cs-file-input">
            </label>

            <button id="downloadBtn" class="cs-btn cs-btn-ghost">‚¨áÔ∏è Download report</button>
          </div>

          <div class="cs-hint muted">‡πÄ‡∏Ñ‡∏•‡πá‡∏î‡∏•‡∏±‡∏ö: ‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å Betaflight CLI (diff all) ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏ü‡∏•‡πå dump ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</div>
        </div>

        <div class="cs-server-status">
          <span class="muted">Server:</span>
          <span id="serverStatus" class="cs-badge cs-badge-muted">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...</span>
        </div>
      </section>

      <!-- Right column: result -->
      <aside class="cs-panel cs-result-panel">
        <div class="cs-result-header">
          <div>
            <div class="muted">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</div>
            <div id="summaryText" class="cs-summary-text">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</div>
          </div>

          <div class="cs-severity">
            <span id="okBadge" class="cs-badge cs-badge-good" hidden>OK</span>
            <span id="warnBadge" class="cs-badge cs-badge-warn" hidden>WARN</span>
            <span id="critBadge" class="cs-badge cs-badge-danger" hidden>CRIT</span>
          </div>
        </div>

        <div id="rulesArea" class="cs-rules">
          <div class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå ‚Äî ‡∏Å‡∏î Analyze ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°</div>
        </div>

        <div class="cs-cli-section">
          <div class="cs-cli-header">
            <div class="muted">‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á CLI ‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</div>
            <button id="copyAllBtn" class="cs-copy-btn">Copy all</button>
          </div>

          <div id="cliBox" class="cs-cli-box">
            <div id="cliLines" class="cs-cli-lines">
              <div class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ ‚Äî ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡πà‡∏≠‡∏ô</div>
            </div>
          </div>
        </div>

        <div class="cs-raw">
          <div class="muted">‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ (raw)</div>
          <pre id="rawParams" class="cs-raw-pre muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</pre>
        </div>

        <footer class="cs-footer muted">
          <div>‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô: 1.0 ¬∑ The CLI Surgeon</div>
          <div>‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡πÄ‡∏û‡∏¥‡πà‡∏° ‡∏ö‡∏≠‡∏Å‡∏ú‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢</div>
        </footer>
      </aside>
    </section>
  </main>

  <script>
  /* ========== Client logic (no inline styling dependence) ========== */
  const serverStatusEl = document.getElementById('serverStatus');
  const dumpEl = document.getElementById('dump');
  const analyzeBtn = document.getElementById('analyzeBtn');
  const analyzeLocalBtn = document.getElementById('analyzeLocalBtn');
  const rulesArea = document.getElementById('rulesArea');
  const cliLines = document.getElementById('cliLines');
  const rawParams = document.getElementById('rawParams');
  const summaryText = document.getElementById('summaryText');
  const copyAllBtn = document.getElementById('copyAllBtn');
  const downloadBtn = document.getElementById('downloadBtn');
  const sampleBtn = document.getElementById('sampleBtn');
  const fileInput = document.getElementById('fileInput');
  const clearBtn = document.getElementById('clearBtn');

  let lastResult = null;

  async function checkServer(){
    try {
      const r = await fetch('/analyze_cli', { method: 'OPTIONS' });
      serverStatusEl.textContent = 'Online';
      serverStatusEl.dataset.status = 'online';
      return true;
    } catch(e){
      serverStatusEl.textContent = 'Offline (local)';
      serverStatusEl.dataset.status = 'offline';
      return false;
    }
  }
  checkServer();

  function parseDumpToParams(text){
    const params = {};
    const lines = text.split(/\r?\n/);
    for (let raw of lines){
      let l = raw.trim();
      if (!l) continue;
      const m = l.match(/^(?:set\s+)?([a-z0-9_\-]+)\s*=\s*(.+)$/i);
      if (m){
        const key = m[1].toLowerCase();
        const val = m[2].replace(/\s+#.*$/,'').trim();
        params[key] = val;
      }
    }
    return params;
  }

  function localAnalyze(params){
    const rules = [];
    const minKeys = ['min_throttle','mincommand','min_throttle_percent'];
    for (let k of minKeys){
      if (params[k]){
        const v = parseFloat(params[k]);
        if (!isNaN(v)){
          if (v < 1000){
            rules.push({id:'min_throttle_low', level:'warning', msg:`min_throttle ‡∏ï‡πà‡∏≥ (${v}) ‚Äî ‡∏≠‡∏≤‡∏à‡πÄ‡∏Å‡∏¥‡∏î motor stutter/idle`, suggestion:'‡∏•‡∏≠‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ min_throttle ‡πÄ‡∏õ‡πá‡∏ô 1000-1020 ‡πÅ‡∏•‡πâ‡∏ß‡∏ó‡∏î‡∏™‡∏≠‡∏ö hover'});
          } else if (v > 1100){
            rules.push({id:'min_throttle_high', level:'info', msg:`min_throttle ‡∏™‡∏π‡∏á (${v})`, suggestion:'‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏•‡∏î‡∏Ñ‡πà‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠ response ‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô'});
          }
        }
      }
    }

    const joined = Object.keys(params).join(' ');
    if (!/failsafe|failsafe_delay|failsafe_off/i.test(joined)){
      rules.push({id:'no_failsafe', level:'warning', msg:'‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ failsafe', suggestion:'‡∏ï‡∏±‡πâ‡∏á failsafe action ‡πÄ‡∏ä‡πà‡∏ô land ‡∏´‡∏£‡∏∑‡∏≠ drop'});
    }

    if (params['looptime']){
      const lt = parseInt(params['looptime']);
      if (!isNaN(lt)){
        if (lt < 1000) rules.push({id:'looptime_low', level:'warning', msg:`looptime ‡∏ï‡πà‡∏≥ (${lt} ¬µs)`, suggestion:'‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö ESC/CPU compatibility'});
        if (lt > 4000) rules.push({id:'looptime_high', level:'warning', msg:`looptime ‡∏™‡∏π‡∏á (${lt} ¬µs)`, suggestion:'‡∏•‡∏î looptime ‡∏´‡∏≤‡∏Å‡∏Æ‡∏≤‡∏£‡πå‡∏î‡πÅ‡∏ß‡∏£‡πå‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö'});
      }
    }

    ['p_roll','p_pitch','p_yaw','pid_p'].forEach(k=>{
      if (params[k]){
        const v = parseFloat(params[k]);
        if (!isNaN(v) && v > 80){
          rules.push({id:'pid_high_'+k, level:'critical', msg:`${k} ‡∏™‡∏π‡∏á‡∏°‡∏≤‡∏Å (${v})`, suggestion:'‡∏•‡∏î P ‡∏•‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£ import ‡∏Ñ‡πà‡∏≤'});
        }
      }
    });

    return rules;
  }

  function suggestCliFixes(rules, params){
    const fixes = [];
    for (let r of rules){
      if (r.id === 'min_throttle_low'){
        fixes.push('set min_throttle = 1000');
      }
      if (r.id.startsWith('pid_high_')){
        const key = r.id.replace('pid_high_','');
        const cur = parseFloat(params[key] || params['p_'+key] || 0);
        if (!isNaN(cur) && cur > 0){
          const newv = Math.round(cur * 0.8 * 1000) / 1000;
          fixes.push(`set ${key} = ${newv}`);
        }
      }
      if (r.id === 'no_failsafe'){
        fixes.push('# Example failsafe settings:');
        fixes.push('set failsafe_delay = 10');
        fixes.push('set failsafe_off_delay = 60');
        fixes.push('set failsafe_throttle = 1000');
      }
    }
    if (fixes.length) fixes.push('save');
    return fixes;
  }

  function renderRules(rules){
    rulesArea.innerHTML = '';
    if (!rules.length){
      const el = document.createElement('div');
      el.className = 'muted';
      el.textContent = '‚úÖ ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÉ‡∏´‡∏ç‡πà‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô';
      rulesArea.appendChild(el);
      return;
    }
    rules.forEach(r=>{
      const w = document.createElement('div');
      w.className = 'cs-rule';
      const left = document.createElement('div');
      left.className = 'cs-rule-left';
      left.dataset.level = r.level;
      const body = document.createElement('div');
      body.className = 'cs-rule-body';
      const h = document.createElement('h4');
      h.className = 'cs-rule-title';
      h.textContent = `[${r.level.toUpperCase()}] ${r.msg}`;
      const p = document.createElement('p');
      p.className = 'muted';
      p.textContent = r.suggestion;
      body.appendChild(h); body.appendChild(p);
      w.appendChild(left); w.appendChild(body);
      rulesArea.appendChild(w);
    });
  }

  function renderCli(fixes){
    cliLines.innerHTML = '';
    if (!fixes || fixes.length === 0){
      cliLines.innerHTML = '<div class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</div>';
      return;
    }
    fixes.forEach((c)=>{
      const row = document.createElement('div');
      row.className = 'cs-cli-line';
      const txt = document.createElement('div');
      txt.className = 'cs-cli-text';
      txt.textContent = c;
      const cp = document.createElement('button');
      cp.className = 'cs-copy-btn';
      cp.textContent = 'Copy';
      cp.onclick = ()=>{ navigator.clipboard.writeText(c); cp.textContent='Copied'; setTimeout(()=>cp.textContent='Copy',1100); };
      row.appendChild(txt);
      row.appendChild(cp);
      cliLines.appendChild(row);
    });
  }

  function renderRawParams(params){
    rawParams.textContent = JSON.stringify(params, null, 2);
  }

  async function analyzeFlow(useLocal=false){
    const txt = dumpEl.value.trim();
    if (!txt){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ß‡∏≤‡∏á diff all / dump ‡∏Å‡πà‡∏≠‡∏ô'); return; }
    summaryText.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå...';
    rulesArea.innerHTML = '';
    cliLines.innerHTML = '<div class="muted">‡∏£‡∏≠‡∏ú‡∏•...</div>';
    rawParams.textContent = '‡∏≠‡πà‡∏≤‡∏ô‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå...';

    if (!useLocal){
      try {
        const res = await fetch('/analyze_cli', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({dump: txt})
        });
        if (res.ok){
          const j = await res.json();
          applyResult(j);
          return;
        }
      } catch(e){
        console.warn('server analyze failed', e);
      }
    }

    const params = parseDumpToParams(txt);
    const rules = localAnalyze(params);
    const fixes = suggestCliFixes(rules, params);
    const out = { summary: `‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ: ${Object.keys(params).length}`, rules, fix_commands: fixes, params };
    applyResult(out);
  }

  function applyResult(j){
    lastResult = j;
    summaryText.textContent = j.summary || '‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏•‡πâ‡∏ß';
    let rules = j.rules || [];
    renderRules(rules);
    const fixes = j.fix_commands || j.fixCommands || j.fix_commands || j.fix_commands || [];
    renderCli(fixes);
    renderRawParams(j.params || {});
    updateSeverityBadge(rules);
  }

  function updateSeverityBadge(rules){
    const ok = document.getElementById('okBadge');
    const warn = document.getElementById('warnBadge');
    const crit = document.getElementById('critBadge');
    ok.hidden = warn.hidden = crit.hidden = true;
    if (!rules || !rules.length) { ok.hidden = false; return; }
    const lv = rules.map(r => r.level);
    if (lv.includes('critical') || lv.includes('danger')) crit.hidden = false;
    if (lv.includes('warning')) warn.hidden = false;
    if (!lv.includes('warning') && !lv.includes('critical')) ok.hidden = false;
  }

  analyzeBtn.onclick = ()=> analyzeFlow(false);
  analyzeLocalBtn.onclick = ()=> analyzeFlow(true);

  copyAllBtn.onclick = ()=>{
    if (!lastResult || !lastResult.fix_commands || lastResult.fix_commands.length === 0){ alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å'); return; }
    const txt = lastResult.fix_commands.join('\n');
    navigator.clipboard.writeText(txt).then(()=>{ copyAllBtn.textContent='Copied'; setTimeout(()=>copyAllBtn.textContent='Copy all',1200); });
  };

  downloadBtn.onclick = ()=>{
    if (!lastResult){ alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô'); return; }
    const blob = new Blob([JSON.stringify(lastResult, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'cli_surgeon_report.json'; a.click();
    URL.revokeObjectURL(url);
  };

  sampleBtn.onclick = ()=>{
    const sample = `# sample diff all\nset min_throttle = 980\nset looptime = 500\nset p_roll = 95\n# end`;
    dumpEl.value = sample;
  };

  fileInput.onchange = (ev)=>{
    const f = ev.target.files[0];
    if (!f) return;
    const r = new FileReader();
    r.onload = ()=> dumpEl.value = r.result;
    r.readAsText(f);
  };

  clearBtn.onclick = ()=>{
    dumpEl.value=''; rulesArea.innerHTML=''; cliLines.innerHTML='<div class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</div>'; rawParams.textContent='‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'; summaryText.textContent='‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå'; lastResult=null;
  };

  // drag & drop handling
  const dz = document.getElementById('dropzone');
  dz.addEventListener('dragover', e=>{ e.preventDefault(); dz.classList.add('cs-dropzone-over'); });
  dz.addEventListener('dragleave', e=>{ dz.classList.remove('cs-dropzone-over'); });
  dz.addEventListener('drop', e=>{
    e.preventDefault(); dz.classList.remove('cs-dropzone-over');
    const f = e.dataTransfer.files && e.dataTransfer.files[0];
    if (f){ const r = new FileReader(); r.onload = ()=> dumpEl.value = r.result; r.readAsText(f); }
    else { const txt = e.dataTransfer.getData('text'); if (txt) dumpEl.value = txt; }
  });

  </script>
</body>
</html>