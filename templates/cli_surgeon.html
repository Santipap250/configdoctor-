<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>The CLI Surgeon ‚Äî ConfigDoctor</title>

  <!-- Embedded modern responsive styles (mobile-first). ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ map ‡πÑ‡∏õ‡∏¢‡∏±‡∏á static/style.css ‡πÉ‡∏´‡πâ‡∏¢‡πâ‡∏≤‡∏¢‡∏Ñ‡∏•‡∏≤‡∏™‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÑ‡∏ü‡∏•‡πå CSS ‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å -->
  <style>
    /* Reset + base */
    :root{
      --bg:#0b1220; --card:#0f1724; --muted:#9aa4b2; --text:#e6eef8;
      --accent:#22d3ee; --accent-2:#7c3aed; --good:#6ee7b7; --warn:#fbbf24; --danger:#fb7185;
      --surface: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      --radius:14px; --glass: rgba(255,255,255,0.03);
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%; margin:0; background:radial-gradient(1200px 600px at 10% 10%, rgba(34,211,238,0.035), transparent), var(--bg); color:var(--text); -webkit-font-smoothing:antialiased}
    a{color:var(--accent)}
    .container{max-width:1200px; margin:28px auto; padding:20px; }

    /* Header */
    .header{display:flex; gap:16px; align-items:center; justify-content:space-between}
    .brand{display:flex; gap:12px; align-items:center}
    .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:800;color:#04111a;font-size:18px;box-shadow: 0 6px 24px rgba(124,58,237,0.18)}
    .title h1{margin:0;font-size:18px}
    .title p{margin:0;color:var(--muted);font-size:13px}

    /* Layout */
    .grid{display:grid; grid-template-columns: 1fr 420px; gap:18px; margin-top:18px}
    @media (max-width:980px){ .grid{grid-template-columns:1fr} }

    /* Panels */
    .panel{background:var(--card); border-radius:var(--radius); padding:14px; box-shadow: 0 8px 30px rgba(2,6,23,0.6); border:1px solid rgba(255,255,255,0.02)}
    .panel h2{margin:0 0 8px 0;font-size:15px}
    .muted{color:var(--muted); font-size:13px}

    /* Input area */
    .dropzone{border:1px dashed rgba(255,255,255,0.04); border-radius:10px; padding:10px; min-height:180px; display:flex; flex-direction:column; gap:8px; background:var(--surface)}
    .textarea{width:100%; min-height:140px; background:transparent; border:0; color:var(--text); outline:none; resize:vertical; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace; font-size:13px; padding:6px}
    .controls{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .btn{background:transparent; border:1px solid rgba(255,255,255,0.04); color:var(--accent); padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:600}
    .btn.ghost{color:var(--muted); border-style:dashed}
    .btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent-2)); color:#04111a; border:0}
    .small{padding:6px 10px; font-size:13px}
    .upload{position:relative; overflow:hidden}
    .upload input[type=file]{position:absolute; left:0; top:0; opacity:0; width:100%; height:100%; cursor:pointer}

    /* Result area */
    .summary-row{display:flex; justify-content:space-between; align-items:flex-start; gap:12px}
    .severity{display:flex; gap:8px; align-items:center}
    .badge{padding:6px 10px; border-radius:999px; font-weight:700; font-size:12px;}
    .badge.ok{background:var(--good); color:#042014}
    .badge.warn{background:var(--warn); color:#042014}
    .badge.crit{background:var(--danger); color:#fff}

    .rules{margin-top:12px; display:flex; flex-direction:column; gap:10px}
    .rule{display:flex; gap:12px; align-items:flex-start; padding:10px; border-radius:10px; background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent); border:1px solid rgba(255,255,255,0.02)}
    .rule .dot{width:10px;height:40px;border-radius:6px}
    .rule .body h4{margin:0;font-size:14px}
    .rule .body p{margin:6px 0 0 0;color:var(--muted);font-size:13px}

    /* CLI box */
    .cli-box{margin-top:12px; background:linear-gradient(180deg, rgba(7,10,14,0.6), rgba(7,10,14,0.4)); border-radius:10px; padding:10px; border:1px solid rgba(255,255,255,0.02)}
    .cli-line{display:flex; gap:8px; align-items:center; justify-content:space-between; padding:6px 8px; border-radius:8px; background:rgba(255,255,255,0.01)}
    .cli-text{font-family: ui-monospace, monospace; color:#cfe8ff; font-size:13px}
    .copy-btn{background:transparent; color:var(--muted); border:1px solid rgba(255,255,255,0.02); padding:6px 8px; border-radius:8px; cursor:pointer}

    /* Raw params */
    .raw{margin-top:12px}
    pre.raw-pre{background:#031027; padding:12px; border-radius:8px; font-family: ui-monospace, monospace; font-size:13px; color:#cfe8ff; max-height:220px; overflow:auto; border:1px solid rgba(255,255,255,0.02)}

    /* Footer small */
    .meta-row{display:flex; gap:12px; justify-content:space-between; align-items:center; margin-top:12px; color:var(--muted); font-size:13px}

    /* Subtle animations */
    .fade-in{animation:fadeIn .35s ease both}
    @keyframes fadeIn{from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:none}}
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <div class="brand">
        <div class="logo">CS</div>
        <div class="title">
          <h1>The CLI Surgeon</h1>
          <p class="muted">‡∏ß‡∏≤‡∏á <code>diff all</code> / <code>dump</code> ‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏ô‡πâ‡∏≤ Betaflight CLI</p>
        </div>
      </div>
      <div class="muted">ConfigDoctor ¬∑ Diagnostic Tool</div>
    </header>

    <main class="grid">
      <!-- Input panel -->
      <section class="panel fade-in" aria-labelledby="input-title">
        <h2 id="input-title">‡∏ß‡∏≤‡∏á CLI Dump / Upload</h2>

        <div class="dropzone" id="dropzone" aria-label="CLI dump dropzone">
          <textarea id="dump" class="textarea" placeholder="‡∏ß‡∏≤‡∏á diff all / dump ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."></textarea>

          <div class="controls">
            <button id="analyzeBtn" class="btn primary">üîé Analyze</button>
            <button id="analyzeLocalBtn" class="btn ghost small">üñ•Ô∏è Analyze (Local)</button>
            <button id="sampleBtn" class="btn small">üìÑ ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</button>

            <label class="btn ghost upload small">
              üìÅ Upload
              <input id="fileInput" type="file" accept=".txt,.log" />
            </label>

            <button id="clearBtn" class="btn ghost small">üßπ ‡∏•‡πâ‡∏≤‡∏á</button>
            <button id="downloadBtn" class="btn ghost small">‚¨áÔ∏è ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
          </div>

          <div class="muted" style="margin-top:8px">‡πÄ‡∏Ñ‡∏•‡πá‡∏î‡∏•‡∏±‡∏ö: ‡πÉ‡∏™‡πà‡∏ú‡∏•‡∏à‡∏≤‡∏Å Betaflight CLI (diff all) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</div>
        </div>

        <div style="margin-top:12px; display:flex; gap:12px; align-items:center; justify-content:space-between">
          <div class="muted">Server:</div>
          <div id="serverStatus" class="badge" style="background:transparent; color:var(--muted); font-weight:700; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,0.02)">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...</div>
        </div>
      </section>

      <!-- Result panel -->
      <aside class="panel fade-in" aria-labelledby="result-title">
        <div class="summary-row">
          <div>
            <div class="muted">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</div>
            <div id="summaryText" style="font-weight:800; margin-top:6px">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</div>
          </div>
          <div class="severity">
            <div id="okBadge" class="badge ok" style="display:none">OK</div>
            <div id="warnBadge" class="badge warn" style="display:none">WARN</div>
            <div id="critBadge" class="badge crit" style="display:none">CRIT</div>
          </div>
        </div>

        <div id="rulesArea" class="rules" aria-live="polite" style="margin-top:12px">
          <div class="muted">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏à‡∏∞‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</div>
        </div>

        <div style="margin-top:12px">
          <div style="display:flex; justify-content:space-between; align-items:center">
            <div class="muted">‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á CLI ‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</div>
            <button id="copyAllBtn" class="copy-btn">Copy all</button>
          </div>

          <div class="cli-box" id="cliBox" style="margin-top:8px">
            <div id="cliLines">
              <div class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</div>
            </div>
          </div>
        </div>

        <div class="raw">
          <div class="muted" style="margin-top:12px">‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ (raw)</div>
          <pre id="rawParams" class="raw-pre">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</pre>
        </div>

        <div class="meta-row">
          <div class="muted">‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô: 1.0 ¬∑ The CLI Surgeon</div>
          <div class="muted">‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡πÄ‡∏û‡∏¥‡πà‡∏° ‡∏ö‡∏≠‡∏Å‡∏ú‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢</div>
        </div>
      </aside>
    </main>
  </div>

  <!-- Script: server-first analyze, local fallback, drag/drop, copy/download -->
  <script>
  (function(){
    const dumpEl = document.getElementById('dump');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const analyzeLocalBtn = document.getElementById('analyzeLocalBtn');
    const sampleBtn = document.getElementById('sampleBtn');
    const fileInput = document.getElementById('fileInput');
    const clearBtn = document.getElementById('clearBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const serverStatus = document.getElementById('serverStatus');
    const rulesArea = document.getElementById('rulesArea');
    const cliLines = document.getElementById('cliLines');
    const rawParams = document.getElementById('rawParams');
    const summaryText = document.getElementById('summaryText');
    const copyAllBtn = document.getElementById('copyAllBtn');
    const okBadge = document.getElementById('okBadge');
    const warnBadge = document.getElementById('warnBadge');
    const critBadge = document.getElementById('critBadge');
    const dropzone = document.getElementById('dropzone');

    let lastResult = null;

    async function checkServer(){
      try{
        const r = await fetch('/analyze_cli', { method: 'OPTIONS' });
        serverStatus.textContent = 'Online';
        serverStatus.style.background = 'linear-gradient(90deg,var(--accent),var(--accent-2))';
        serverStatus.style.color = '#04111a';
        return true;
      }catch(e){
        serverStatus.textContent = 'Offline (local)';
        serverStatus.style.background = 'transparent';
        serverStatus.style.color = 'var(--muted)';
        return false;
      }
    }
    checkServer();

    /* ---------- Parser (lightweight, local fallback) ---------- */
    function parseDumpToParams(text){
      const params = {};
      const lines = text.split(/\r?\n/);
      for (let raw of lines){
        let ln = raw.replace(/(#|;).*$/,'').trim();
        if (!ln) continue;
        const m = ln.match(/^(?:set\s+)?([a-z0-9_\-]+)\s*=\s*(.+)$/i);
        if (m){
          const k = m[1].toLowerCase().replace(/-/g,'_');
          let v = m[2].trim().replace(/^["']|["']$/g,'');
          if (/^-?\d+(\.\d+)?$/.test(v)) v = (v.indexOf('.')>-1? parseFloat(v) : parseInt(v));
          params[k] = v;
        } else {
          const parts = ln.split(/\s+/,2);
          if (parts.length==2){
            const k = parts[0].toLowerCase().replace(/-/g,'_');
            let v = parts[1].trim();
            if (/^-?\d+(\.\d+)?$/.test(v)) v = (v.indexOf('.')>-1? parseFloat(v) : parseInt(v));
            params[k] = params[k] || v;
          }
        }
      }
      params['_raw_lines'] = lines.slice(0,200);
      return params;
    }

    function localAnalyze(params){
      const rules = [];
      // min throttle checks
      const minKeys = ['min_throttle','mincommand','min_throttle_percent'];
      for (let k of minKeys){
        if (k in params){
          const v = Number(params[k]);
          if (!isNaN(v)){
            if (v < 1000) rules.push({id:'min_throttle_low', level:'warning', msg:`${k} ‡∏ï‡πà‡∏≥ (${v}) ‚Äî ‡∏≠‡∏≤‡∏à‡πÄ‡∏Å‡∏¥‡∏î motor stutter/idle`, suggestion:'‡∏ï‡∏±‡πâ‡∏á min_throttle ~1000-1020 ‡πÅ‡∏•‡∏∞‡∏ó‡∏î‡∏™‡∏≠‡∏ö hover'});
            else if (v > 1100) rules.push({id:'min_throttle_high', level:'info', msg:`${k} ‡∏™‡∏π‡∏á (${v})`, suggestion:'‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏•‡∏î‡∏´‡∏≤‡∏Å response ‡πÅ‡∏¢‡πà'});
          }
          break;
        }
      }
      // failsafe
      const raw = (params['_raw_lines']||[]).join('\n').toLowerCase();
      if (!(/failsafe|failsafe_delay|failsafe_throttle|failsafe_action/.test(raw))) {
        rules.push({id:'no_failsafe', level:'warning', msg:'‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ failsafe', suggestion:'‡∏ï‡∏±‡πâ‡∏á failsafe action/delay/throttle'});
      }
      // looptime
      if ('looptime' in params){
        const lt = Number(params['looptime']);
        if (!isNaN(lt)){
          if (lt < 1000) rules.push({id:'looptime_low', level:'warning', msg:`looptime ‡∏ï‡πà‡∏≥ (${lt})`, suggestion:'‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏≤‡∏Å instability'});
          if (lt > 4000) rules.push({id:'looptime_high', level:'warning', msg:`looptime ‡∏™‡∏π‡∏á (${lt})`, suggestion:'‡∏•‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î latency ‡∏´‡∏≤‡∏Å‡∏Æ‡∏≤‡∏£‡πå‡∏î‡πÅ‡∏ß‡∏£‡πå‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö'});
        }
      }
      // pid
      ['p_roll','p_pitch','p_yaw','p_roll','p_pitch','p_yaw','pid_p'].forEach(k=>{
        if (k in params){
          const v = Number(params[k]);
          if (!isNaN(v) && v > 80) rules.push({id:'pid_high_'+k, level:'critical', msg:`${k} ‡∏™‡∏π‡∏á (${v})`, suggestion:'‡∏•‡∏î P/I/D ‡∏•‡∏á 15-25% ‡πÅ‡∏•‡∏∞‡∏ó‡∏î‡∏™‡∏≠‡∏ö'});
          if (!isNaN(v) && v === 0) rules.push({id:'pid_zero_'+k, level:'info', msg:`${k} = 0`, suggestion:'‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà'});
        }
      });
      // serial/telemetry
      if (!(/serial|telemetry|uart|receiver|serialrx/.test(raw))) {
        rules.push({id:'no_serial', level:'info', msg:'‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ serial/telemetry/receiver', suggestion:'‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏û‡∏≠‡∏£‡πå‡∏ï‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ELRS/FrSky/OSD'});
      }
      // vtx/osd tokens
      if (/vtx|smartaudio|tramp|pitmode|vtx_power/.test(raw)){
        rules.push({id:'vtx_found', level:'info', msg:'‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ VTX/SmartAudio/Tramp', suggestion:'‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö power/channel/antenna/region'});
      }

      return rules;
    }

    function suggestCliFixes(rules, params){
      const fixes = [];
      const push = (k,v)=> fixes.push(`set ${k} = ${v}`);
      rules.forEach(r=>{
        if (r.id==='min_throttle_low'){
          if ('min_throttle' in params) push('min_throttle', 1000);
          else push('min_throttle', 1000);
        } else if (r.id.startsWith('pid_high_')){
          const key = r.id.replace('pid_high_','');
          if (key in params && !isNaN(Number(params[key]))){
            const cur = Number(params[key]);
            const newv = Math.round(cur * 0.8 * 1000) / 1000;
            push(key, newv);
          }
        } else if (r.id==='no_failsafe'){
          push('failsafe_delay', 10);
          push('failsafe_off_delay', 60);
          push('failsafe_throttle', 1000);
        } else if (r.id==='looptime_low'){
          if ('looptime' in params) push('looptime', 1000);
        }
      });
      if (fixes.length && fixes[fixes.length-1] !== 'save') fixes.push('save');
      return fixes;
    }

    // render helpers
    function renderRules(rules){
      rulesArea.innerHTML = '';
      if (!rules || rules.length===0){
        const el = document.createElement('div'); el.className='muted'; el.textContent='‚úÖ ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÉ‡∏´‡∏ç‡πà‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô'; rulesArea.appendChild(el); return;
      }
      rules.forEach(r=>{
        const el = document.createElement('div'); el.className='rule';
        const dot = document.createElement('div'); dot.className='dot';
        dot.style.background = (r.level==='critical' ? 'var(--danger)' : (r.level==='warning' ? 'var(--warn)' : 'var(--accent)'));
        const body = document.createElement('div'); body.className='body';
        const h4 = document.createElement('h4'); h4.textContent = `[${r.level.toUpperCase()}] ${r.msg}`;
        const p = document.createElement('p'); p.className='muted'; p.textContent = r.suggestion;
        body.appendChild(h4); body.appendChild(p);
        el.appendChild(dot); el.appendChild(body);
        rulesArea.appendChild(el);
      });
    }

    function renderCli(fixes){
      cliLines.innerHTML = '';
      if (!fixes || fixes.length===0){ cliLines.innerHTML = '<div class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</div>'; return; }
      fixes.forEach(c=>{
        const row = document.createElement('div'); row.className='cli-line';
        const left = document.createElement('div'); left.className='cli-text'; left.textContent = c;
        const cp = document.createElement('button'); cp.className='copy-btn'; cp.textContent='Copy';
        cp.onclick = ()=>{ navigator.clipboard.writeText(c); cp.textContent='Copied'; setTimeout(()=>cp.textContent='Copy',1100); };
        row.appendChild(left); row.appendChild(cp); cliLines.appendChild(row);
      });
    }

    function renderRaw(params){
      rawParams.textContent = JSON.stringify(params, null, 2);
    }

    function updateSeverity(rules){
      okBadge.style.display = warnBadge.style.display = critBadge.style.display = 'none';
      if (!rules || rules.length===0) { okBadge.style.display='inline-flex'; return; }
      const levels = rules.map(r=>r.level);
      if (levels.includes('critical') || levels.includes('danger')) critBadge.style.display='inline-flex';
      if (levels.includes('warning')) warnBadge.style.display='inline-flex';
      if (!levels.includes('warning') && !levels.includes('critical')) okBadge.style.display='inline-flex';
    }

    async function analyzeFlow(useLocal=false){
      const txt = dumpEl.value.trim();
      if (!txt){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ß‡∏≤‡∏á diff all / dump ‡∏Å‡πà‡∏≠‡∏ô'); return; }
      summaryText.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå...';
      rulesArea.innerHTML = ''; cliLines.innerHTML = '<div class="muted">‡∏£‡∏≠‡∏ú‡∏•...</div>'; rawParams.textContent = '‡∏≠‡πà‡∏≤‡∏ô‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå...';

      if (!useLocal){
        try{
          const res = await fetch('/analyze_cli', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({dump:txt}) });
          if (res.ok){
            const j = await res.json();
            applyResult(j); return;
          }
        } catch(e){ console.warn('Server analyze failed', e); }
      }

      // local fallback
      const params = parseDumpToParams(txt);
      const rules = localAnalyze(params);
      const fixes = suggestCliFixes(rules, params);
      const out = { summary: `‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ: ${Object.keys(params).length}`, rules, fix_commands: fixes, params };
      applyResult(out);
    }

    function applyResult(data){
      lastResult = data;
      summaryText.textContent = data.summary || '‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏•‡πâ‡∏ß';
      const rules = data.rules || [];
      renderRules(rules);
      let fixes = data.fix_commands || data.fixCommands || data.fixCommands || [];
      renderCli(fixes);
      renderRaw(data.params || {});
      updateSeverity(rules);
    }

    // events
    analyzeBtn.addEventListener('click', ()=>analyzeFlow(false));
    analyzeLocalBtn.addEventListener('click', ()=>analyzeFlow(true));
    sampleBtn.addEventListener('click', ()=>{ dumpEl.value = "# sample\nset min_throttle = 980\nset looptime = 500\nset p_roll = 95\n# end"; });
    clearBtn.addEventListener('click', ()=>{ dumpEl.value=''; rulesArea.innerHTML=''; cliLines.innerHTML='<div class=\"muted\">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</div>'; rawParams.textContent='‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'; summaryText.textContent='‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå'; lastResult=null;});
    fileInput.addEventListener('change', (ev)=>{ const f = ev.target.files[0]; if (!f) return; const r = new FileReader(); r.onload = ()=> dumpEl.value = r.result; r.readAsText(f); });

    copyAllBtn.addEventListener('click', ()=>{
      if (!lastResult || !lastResult.fix_commands || lastResult.fix_commands.length===0){ alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å'); return; }
      const txt = lastResult.fix_commands.join('\n');
      navigator.clipboard.writeText(txt).then(()=>{ copyAllBtn.textContent='Copied'; setTimeout(()=>copyAllBtn.textContent='Copy all',1200); });
    });

    downloadBtn.addEventListener('click', ()=>{
      if (!lastResult){ alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô'); return; }
      const blob = new Blob([JSON.stringify(lastResult, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'cli_surgeon_report.json'; a.click(); URL.revokeObjectURL(url);
    });

    // drag & drop
    dropzone.addEventListener('dragover', e=>{ e.preventDefault(); dropzone.style.borderColor='rgba(255,255,255,0.08)'; });
    dropzone.addEventListener('dragleave', e=>{ dropzone.style.borderColor='rgba(255,255,255,0.04)'; });
    dropzone.addEventListener('drop', e=>{ e.preventDefault(); dropzone.style.borderColor='rgba(255,255,255,0.04)'; const f = e.dataTransfer.files && e.dataTransfer.files[0]; if (f){ const r = new FileReader(); r.onload = ()=> dumpEl.value = r.result; r.readAsText(f); } else { const t = e.dataTransfer.getData('text'); if (t) dumpEl.value = t; } });

  })();
  </script>
</body>
</html>